{% extends "authenticated_base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
<style>
    /* Hide the floating dashboard button */
    .btn.btn-outline-primary.position-fixed {
        display: none !important;
    }

    /* Full-height layout */
    .spreadsheet-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 0;
        margin: 0;
    }
    
    .spreadsheet-toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        padding: 8px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
        min-height: 48px;
    }
    
    .spreadsheet-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    #transaction-spreadsheet {
        flex: 1;
        width: 100%;
        height: 100%;
        min-height: 0; /* for flex child */
    }
    
    .spreadsheet-status {
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
        padding: 8px 16px;
        font-size: 13px;
        flex-shrink: 0;
    }
    
    /* Toolbar buttons styling */
    .toolbar-btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #dadce0;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .toolbar-btn:hover {
        background: #f1f3f4;
    }
    
    .toolbar-btn.primary {
        background: #1a73e8;
        color: white;
        border-color: #1a73e8;
    }
    
    .toolbar-btn.primary:hover {
        background: #1557b0;
    }
    
    .toolbar-separator {
        width: 1px;
        height: 20px;
        background: #dadce0;
        margin: 0 4px;
    }
    
    /* Handsontable styling adjustments */
    .handsontable {
        font-family: 'Roboto', 'Arial', sans-serif;
        font-size: 13px;
    }
    
    .handsontable .htInvalid {
        background-color: #fce8e6 !important;
    }
    
    .handsontable .htDimmed {
        color: #5f6368;
    }
    
    .handsontable .htCore {
        border: none;
    }
    
    .handsontable td {
        border-right: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .handsontable th {
        background: #f8f9fa;
        border-right: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;
        font-weight: 500;
        color: #3c4043;
    }
    
    /* Dark theme adjustments */
    body.dark-theme .spreadsheet-toolbar,
    body.dark-theme .spreadsheet-status {
        background: #2d2d2d;
        border-color: #444;
        color: #e1e1e1;
    }
    
    body.dark-theme .toolbar-btn {
        background: #3c4043;
        border-color: #5f6368;
        color: #e1e1e1;
    }
    
    body.dark-theme .toolbar-btn:hover {
        background: #48494a;
    }
    
    body.dark-theme .handsontable td {
        border-color: #444;
        background: #2d2d2d;
        color: #e1e1e1;
    }
    
    body.dark-theme .handsontable th {
        background: #3c4043;
        border-color: #444;
        color: #e1e1e1;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="spreadsheet-container">
    <!-- Toolbar -->
    <div class="spreadsheet-toolbar">
        <h5 class="mb-0 me-3">Transaction Spreadsheet</h5>
        
        <button id="save-spreadsheet-btn" class="toolbar-btn primary">
            <i class="mdi mdi-content-save"></i>
            Save
        </button>
        
        <button id="add-row-btn" class="toolbar-btn">
            <i class="mdi mdi-plus"></i>
            Add Row
        </button>
        
        <div class="toolbar-separator"></div>
        
        <button id="undo-btn" class="toolbar-btn" title="Undo">
            <i class="mdi mdi-undo"></i>
        </button>
        
        <button id="redo-btn" class="toolbar-btn" title="Redo">
            <i class="mdi mdi-redo"></i>
        </button>
        
        <div class="toolbar-separator"></div>
        
        <a href="{% url 'dashboard' %}" class="toolbar-btn">
            <i class="mdi mdi-arrow-left"></i>
            Dashboard
        </a>
    </div>
    
    <!-- Spreadsheet Content -->
    <div class="spreadsheet-content">
        <div id="transaction-spreadsheet"></div>
    </div>
    
    <!-- Status Bar -->
    <div id="status-message" class="spreadsheet-status">
        Ready
    </div>
</div>
{% csrf_token %}
{{ accounts_json|json_script:"accounts-data" }}
{{ categories_json|json_script:"categories-data" }}
{{ transaction_types_json|json_script:"transaction-types-data" }}
{{ initial_data_json|json_script:"initial-spreadsheet-data" }}



<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const accountsData = JSON.parse(document.getElementById('accounts-data').textContent);
    const categoriesData = JSON.parse(document.getElementById('categories-data').textContent);
    const transactionTypesData = JSON.parse(document.getElementById('transaction-types-data').textContent);
    const initialSpreadsheetData = JSON.parse(document.getElementById('initial-spreadsheet-data').textContent);

    
    const container = document.getElementById('transaction-spreadsheet');
    const saveButton = document.getElementById('save-spreadsheet-btn');
    const addRowButton = document.getElementById('add-row-btn');
    const statusMessageEl = document.getElementById('status-message');

    const modifiedRowIndexes = new Set(); 


    // Prepare sources for dropdowns
    const accountNames = accountsData.map(acc => acc.name + ' (' + acc.account_number + ')');
    const categoryNames = categoriesData.map(cat => cat.name);
    const transactionTypeNames = transactionTypesData.map(tt => tt.name);

    const hot = new Handsontable(container, {
        data: initialSpreadsheetData.length > 0 ? initialSpreadsheetData : [{}],
        rowHeaders: true,
        colHeaders: ['ID', 'Date', 'Account', 'Category', 'Description', 'Amount', 'Type'],
        columns: [
            { data: 'id', readOnly: true, type: 'numeric', width: 50 }, // Transaction ID column, read only
            { data: 'date', type: 'date', dateFormat: 'YYYY-MM-DD', correctFormat: true, allowInvalid: false },
            {
                data: 'account_name',
                type: 'dropdown', 
                source: accountNames,
                allowInvalid: false,
                validator: function (value, callback) {
                    // Allow empty for new rows or if account is not set
                    if (value === null || value === '' || accountNames.includes(value)) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                }
            },
            { 
                data: 'category_name',
                type: 'dropdown', 
                source: categoryNames,
                allowInvalid: false,
                validator: function (value, callback) {
                     // Allow empty for new rows or if category is not set
                    if (value === null || value === '' || categoryNames.includes(value)) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                }
            },
            { data: 'description', type: 'text' },
            { data: 'amount', type: 'numeric', numericFormat: { pattern: '0,0.00' }, allowInvalid: false },
            { 
                data: 'transaction_type_name',
                type: 'dropdown', 
                source: transactionTypeNames,
                allowInvalid: false,
                validator: function (value, callback) {
                    if (value === null || value === '' || transactionTypeNames.includes(value)) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                }
            }
        ],
        // to hide the id column:
        // hiddenColumns: {
        //  columns: [0], // Index of the ID column
        //  indicators: false // Do not show hidden column indicators
        // },
        minRows: 50, 
        minSpareRows: 10, 
        width: '100%',
        height: '100%', 
        stretchH: 'all',
        licenseKey: 'non-commercial-and-evaluation',
        
        // Enhanced features
        manualRowMove: true,
        manualColumnMove: true,
        manualRowResize: true,
        manualColumnResize: true,
        
        // Context menu and interaction
        contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'col_left', 'col_right', 'remove_col'],
        filters: true,
        dropdownMenu: ['filter_by_condition', 'filter_operators', 'filter_by_condition2', 'filter_by_value', 'filter_action_bar'],
        
        // Selection and navigation
        fillHandle: true,
        autoWrapRow: true,
        autoWrapCol: true,
        
        // Grid appearance
        rowHeaders: true,
        colHeaders: true,
        outsideClickDeselects: false,
        
        // Performance
        virtualization: true,
        
        afterChange: function (changes, source) {
            if (source === 'loadData' || !changes) {
                return; 
            }
            changes.forEach(([rowIndex, prop, oldValue, newValue]) => {
                if (String(oldValue) !== String(newValue)) {
                    modifiedRowIndexes.add(rowIndex);
                    updateStatus(`Modified row ${rowIndex + 1}`);
                }
            });
        },
        
        afterSelection: function(row, column, row2, column2, preventScrolling, selectionLayerLevel) {
            updateStatus(`Selected: R${row + 1}C${column + 1}`);
        }
    });

    function updateStatus(message) {
        const statusEl = document.getElementById('status-message');
        statusEl.textContent = message;
        setTimeout(() => {
            statusEl.textContent = 'Ready';
        }, 3000);
    }

    // keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 's':
                    e.preventDefault();
                    document.getElementById('save-spreadsheet-btn').click();
                    break;
                case 'z':
                    if (!e.shiftKey) {
                        e.preventDefault();
                        hot.undo();
                    }
                    break;
                case 'y':
                    e.preventDefault();
                    hot.redo();
                    break;
            }
        }
    });

    // undo/redo button functionality (fix hot undo/redo with plugin since depreciated)
    document.getElementById('undo-btn').addEventListener('click', () => {
        hot.undo();
    });

    document.getElementById('redo-btn').addEventListener('click', () => {
        hot.redo();
    });

    addRowButton.addEventListener('click', function() {
        hot.alter('insert_row_below');
    });

    saveButton.addEventListener('click', function () {
    const tableData = hot.getSourceData();
    const transactionsToSave = [];
    statusMessageEl.innerHTML = '<span class="text-info">Saving...</span>';

    tableData.forEach((row, rowIndex) => {
        const isNew = !row.id && row.date && row.amount != null;
        const isModified = row.id && modifiedRowIndexes.has(rowIndex);
        if (isNew || isModified) {
            const account = accountsData.find(acc => acc.name === row.account_name);
            const category = categoriesData.find(cat => cat.name === row.category_name);
            const transactionType = transactionTypesData.find(tt => tt.name === row.transaction_type_name);

            transactionsToSave.push({
                id: row.id || null,
                date: row.date,
                account_id: account ? account.id : null,
                category_id: category ? category.id : null,
                description: row.description || '',
                amount: row.amount,
                transaction_type: transactionType ? transactionType.id : (row.transaction_type_name ? row.transaction_type_name.toLowerCase() : 'expense')
            });
        }
    });

    if (transactionsToSave.length === 0) {
        statusMessageEl.innerHTML = '<span class="text-warning">No new or modified transactions to save.</span>';
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'save_spreadsheet_transactions' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify(transactionsToSave)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            statusMessageEl.innerHTML = `<span class="text-success">${data.message}</span>`;
            modifiedRowIndexes.clear();
            setTimeout(() => {
            window.location.reload();
            }, 1500);
        } else {
            let errorMessages = data.message || 'An error occurred.';
            if (data.errors && data.errors.length > 0) {
                errorMessages += '<ul>' + data.errors.map(err => `<li>${err}</li>`).join('') + '</ul>';
            }
            statusMessageEl.innerHTML = `<div class="alert alert-danger">${errorMessages}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusMessageEl.innerHTML = '<span class="text-danger">An error occurred while saving. Check console.</span>';
    });
});
});
</script>

{% endblock %}
