{% extends "authenticated_base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/visualizations/pie_chart.css' %}">
{% endblock %}

{% block content %}
<div class="pie-chart-page">
    <div class="container-fluid">
        <div class="pie-chart-card">
            <div class="header-section">
                <h1 class="page-title">Financial Distribution Analysis</h1>
                <div class="nav-buttons">
                    <a href="{% url 'visualization_hub' %}" class="nav-btn">
                        <i class="mdi mdi-arrow-left me-2"></i>All Visualizations
                    </a>
                    <a href="{% url 'dashboard' %}" class="nav-btn">
                        <i class="mdi mdi-view-dashboard me-2"></i>Dashboard
                    </a>
                </div>
            </div>

            <div class="stats-summary">
                <div class="stat-card income">
                    <h3>${{ total_income|floatformat:2 }}</h3>
                    <p>Total Income</p>
                </div>
                <div class="stat-card expense">
                    <h3>${{ total_expenses|floatformat:2 }}</h3>
                    <p>Total Expenses</p>
                </div>
                <div class="stat-card net {% if net_balance >= 0 %}positive{% else %}negative{% endif %}">
                    <h3>${{ net_balance|floatformat:2 }}</h3>
                    <p>Net Balance</p>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <h3 class="chart-title">Income vs Expenses</h3>
                    <div class="pie-chart-wrapper">
                        <canvas id="overview-pie-chart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title income">Income Categories</h3>
                    <div class="pie-chart-wrapper">
                        {% if income_categories %}
                            <canvas id="income-pie-chart"></canvas>
                        {% else %}
                            <p class="text-center text-muted">No income categories available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <h3 class="chart-title expense">Expense Categories</h3>
                    <div class="pie-chart-wrapper">
                        {% if expense_categories %}
                            <canvas id="expense-pie-chart"></canvas>
                        {% else %}
                            <p class="text-center text-muted">No expense categories available</p>
                        {% endif %}
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Summary</h3>
                    <div style="padding: 2rem; text-align: center;">
                        <div style="margin-bottom: 1rem;">
                            <strong>Financial Health Score:</strong>
                            <div style="font-size: 2rem; margin: 1rem 0; color: {% if net_balance >= 0 %}#16a34a{% else %}#dc2626{% endif %};">
                                {% if total_income > 0 %}
                                    {% widthratio net_balance total_income 100 %}%
                                {% else %}
                                    0%
                                {% endif %}
                            </div>
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            {% if net_balance >= 0 %}
                                You're in good financial shape!
                            {% else %}
                                Consider reviewing your expenses.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="category-breakdown">
                <div class="breakdown-card">
                    <h3 class="breakdown-title income">Income Categories</h3>
                    {% if income_categories %}
                        <ul class="category-list">
                            {% for category in income_categories %}
                            <li class="category-item">
                                <span class="category-name">{{ category.name }}</span>
                                <span class="category-amount">${{ category.amount|floatformat:2 }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-center text-muted">No income categories found</p>
                    {% endif %}
                </div>

                <div class="breakdown-card">
                    <h3 class="breakdown-title expense">Expense Categories</h3>
                    {% if expense_categories %}
                        <ul class="category-list">
                            {% for category in expense_categories %}
                            <li class="category-item">
                                <span class="category-name">{{ category.name }}</span>
                                <span class="category-amount">${{ category.amount|floatformat:2 }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-center text-muted">No expense categories found</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>


<script id="overview-data" type="application/json">
{
    "total_income": {{ total_income }},
    "total_expenses": {{ total_expenses }},
    "net_balance": {{ net_balance }}
}
</script>

{{ income_categories|json_script:"income-categories-data" }}
{{ expense_categories|json_script:"expense-categories-data" }}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/visualizations/pie_chart.js' %}"></script>
{% endblock %}