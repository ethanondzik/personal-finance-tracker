{% extends "authenticated_base.html" %}
{% load static %}

{% block title %}Transaction Heatmap (D3) - {{ block.super }}{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <style>
    .heatmap-container-wrapper {
        padding: 20px;
        background-color: var(--bs-body-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-top: 1rem;
        overflow-x: auto;
    }
    body.dark-theme .card-title {
        color: #e1e1e1; 
    }
    body.dark-theme .heatmap-container-wrapper {
        background-color: #232227; 
        border: 1px solid #444;
    }

    .calendar-heatmap {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .calendar-heatmap .month-label {
        font-size: 10px;
        fill: #767676;
    }
    .calendar-heatmap .day-cell {
        stroke: rgba(27, 31, 35, 0.06);
        stroke-width: 1px;
    }
    .calendar-heatmap .day-cell:hover {
        stroke: rgba(27, 31, 35, 0.3);
    }
    .calendar-heatmap .wday-label {
        font-size: 9px;
        fill: #767676;
    }

    body.dark-theme .calendar-heatmap .month-label,
    body.dark-theme .calendar-heatmap .wday-label {
        fill: #888;
    }
    body.dark-theme .calendar-heatmap .day-cell {
        stroke: rgba(100, 100, 100, 0.2);
    }
     body.dark-theme .calendar-heatmap .day-cell:hover {
        stroke: rgba(150, 150, 150, 0.5);
    }
    .tooltip {
        position: absolute;
        text-align: center;
        padding: 4px 8px;
        font: 12px sans-serif;
        background: #333;
        color: #fff;
        border: 0px;
        border-radius: 4px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 1070; /* Ensure tooltip is above other elements */
    }
    body.dark-theme .tooltip {
        background: #f0f0f0;
        color: #333;
    }
    .heatmap-toggle {
        margin-bottom: 15px;
        text-align: center;
    }
    .heatmap-toggle label {
        margin-right: 10px;
        margin-left: 5px;
    }

  </style>
{% endblock %}

{% block content %}
<div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
        <div class="main-panel" style="width: 100%;">
            <div class="content-wrapper">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-rounded">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h2 class="card-title mb-0">Transaction Activity Heatmap</h2>
                                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                        <i class="mdi mdi-arrow-left me-2"></i>Back to Dashboard
                                    </a>
                                </div>
                                <div class="heatmap-toggle">
                                    <input type="radio" id="modeCount" name="heatmapMode" value="count" checked>
                                    <label for="modeCount">Transaction Count</label>
                                    <input type="radio" id="modeNetActivity" name="heatmapMode" value="netActivity">
                                    <label for="modeNetActivity">Net Activity (Income/Expense)</label>
                                </div>
                                <div class="heatmap-container-wrapper">
                                    <div id="d3-calendar-heatmap-container">
                                        <!-- D3 Heatmap rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ calendar_heatmap_data_json|json_script:"calendar-heatmap-data" }}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const heatmapDataEl = document.getElementById('calendar-heatmap-data');
        const container = document.getElementById('d3-calendar-heatmap-container');
        const modeRadios = document.querySelectorAll('input[name="heatmapMode"]');

        if (!heatmapDataEl || !container) {
            console.error('Required elements for D3 heatmap not found.');
            if (container) container.innerHTML = '<p class="text-danger">Error: Could not initialize heatmap.</p>';
            return;
        }

        const rawData = JSON.parse(heatmapDataEl.textContent || '{}'); 
        const dataByDate = new Map();
        for (const dateStr in rawData) {
            if (rawData.hasOwnProperty(dateStr)) {
                dataByDate.set(dateStr, rawData[dateStr]);
            }
        }

        const cellSize = 15; 
        const cellPadding = 2; 
        const weekDayLabelWidth = 30; 
        const monthLabelHeight = 20; 
        const currentYear = new Date().getFullYear();
        const startDate = new Date(currentYear, 0, 1); 
        const endDate = new Date(currentYear + 1, 0, 1);
        const firstDayOfYearForWeekCalc = d3.timeSunday.floor(new Date(currentYear, 0, 1)); 
        const lastDayOfYearForWeekCalc = d3.timeSunday.ceil(new Date(currentYear, 11, 31)); 
        const numWeeks = d3.timeWeek.count(firstDayOfYearForWeekCalc, lastDayOfYearForWeekCalc);
        const width = (cellSize + cellPadding) * numWeeks + weekDayLabelWidth; 
        const height = (cellSize + cellPadding) * 7 + monthLabelHeight; 
        const dates = d3.timeDays(startDate, endDate); 

        // Define color variables for transaction count, from light grey to dark green
        const colourLowCount = '#EBEDF0'; 
        const colourMidLowCount = '#c6e48b';
        const colourMidCount = '#7bc96f';
        const colourMidHighCount = '#239a3b';
        const colourHighCount = '#196127'; 

        const countColorScale = d3.scaleThreshold()
            .domain([1, 3, 6, 10]) 
            .range([colourLowCount, colourMidLowCount, colourMidCount, colourMidHighCount, colourHighCount]); 

        
        // Define color variables for net activity
        const colourNetIncome = "rgba(76, 175, 80, 0.8)";       // Green
        const colourNetExpense = "rgba(244, 67, 54, 0.8)";      // Red
        const colourNeutralOrMixed = "rgba(255, 193, 7, 0.7)";  // Amber/Yellow
        const colourNoTransactions = "#EBEDF0";                 // Light Grey

        const netActivityColorScale = d3.scaleOrdinal()
            .domain(["netIncome", "netExpense", "neutralOrMixed", "noTransactions"])
            .range([colourNetIncome, colourNetExpense, colourNeutralOrMixed, colourNoTransactions]); 

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip");

        function drawHeatmap(mode) {
            container.innerHTML = ''; // Clear previous heatmap

            const svg = d3.select(container)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("class", "calendar-heatmap");

            svg.append("g")
                .attr("transform", `translate(${weekDayLabelWidth}, ${monthLabelHeight})`)
                .selectAll(".day-cell")
                .data(dates)
                .enter().append("rect")
                .attr("class", "day-cell")
                .attr("width", cellSize)
                .attr("height", cellSize)
                .attr("x", d => d3.timeWeek.count(startDate, d) * (cellSize + cellPadding))
                .attr("y", d => d.getDay() * (cellSize + cellPadding))
                .attr("fill", d => {
                    const dateStr = d3.timeFormat("%Y-%m-%d")(d);
                    const dayData = dataByDate.get(dateStr);

                    if (mode === 'count') {
                        const count = dayData ? dayData.count : 0;
                        return countColorScale(count);
                    } else if (mode === 'netActivity') {
                        if (!dayData || dayData.count === 0) {
                            return netActivityColorScale("noTransactions");
                        }
                        const net = dayData.income - dayData.expense;
                        if (net > 0) {
                            return netActivityColorScale("netIncome");
                        } else if (net < 0) {
                            return netActivityColorScale("netExpense");
                        } else { // net === 0 but there were transactions
                            return netActivityColorScale("neutralOrMixed");
                        }
                    }
                    return '#EBEDF0'; // Default fallback
                })
                .on("mouseover", function(event, d) {
                    d3.select(this).style("stroke", "black"); 
                    tooltip.transition().duration(100).style("opacity", .9);
                    const dateStr = d3.timeFormat("%Y-%m-%d")(d);
                    const dayData = dataByDate.get(dateStr);
                    
                    let tooltipHtml = `No transactions<br/>on ${d3.timeFormat("%b %d, %Y")(d)}`;
                    if (dayData) {
                        tooltipHtml = `
                            ${dayData.count} transaction(s)<br/>
                            Income: ${dayData.income.toFixed(2)}<br/>
                            Expense: ${dayData.expense.toFixed(2)}<br/>
                            Net: ${(dayData.income - dayData.expense).toFixed(2)}<br/>
                            on ${d3.timeFormat("%b %d, %Y")(d)}
                        `;
                    }
                    tooltip.html(tooltipHtml)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this).style("stroke", null); 
                    tooltip.transition().duration(300).style("opacity", 0);
                });
                
            svg.append("g")
                .attr("transform", `translate(${weekDayLabelWidth}, 0)`) 
                .selectAll(".month-label")
                .data(d3.timeMonths(new Date(currentYear, 0, 1), new Date(currentYear, 11, 2))) 
                .enter().append("text")
                .attr("class", "month-label")
                .attr("x", d => d3.timeWeek.count(startDate, d3.timeWeek.floor(d)) * (cellSize + cellPadding) + (cellSize + cellPadding)/2)
                .attr("y", monthLabelHeight - 5)
                .text(d3.timeFormat("%b"));

            const dayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            svg.append("g")
                .attr("transform", `translate(0, ${monthLabelHeight})`)
                .selectAll(".wday-label")
                .data([1, 3, 5]) 
                .enter().append("text")
                .attr("class", "wday-label")
                .attr("x", weekDayLabelWidth - 5)
                .attr("y", d => d * (cellSize + cellPadding) + cellSize / 1.5) 
                .attr("text-anchor", "end")
                .text(d => dayLabels[d].substring(0,1)); 
        }

        modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                drawHeatmap(this.value);
            });
        });

        // Initial draw
        try {
            drawHeatmap(document.querySelector('input[name="heatmapMode"]:checked').value);
            if (Object.keys(rawData).length === 0 && dates.length > 0) {
                 // console.log('No raw data, but dates generated. Displaying blank heatmap for ' + currentYear);
            } else if (dates.length === 0) {
                container.innerHTML = '<p class="text-danger">Error generating dates for the calendar.</p>';
            }
        } catch (e) {
            console.error('Error rendering D3 heatmap:', e);
            if (container) container.innerHTML = '<p class="text-danger">An error occurred while rendering the D3 heatmap.</p>';
        }
    });
  </script>
{% endblock %}

