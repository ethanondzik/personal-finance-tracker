{% extends "authenticated_base.html" %}
{% load static %}

{% block title %}Transaction Heatmap - {{ block.super }}{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <!-- Cal-Heatmap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.css">
  <style>
    .heatmap-container-wrapper {
        padding: 20px;
        background-color: var(--bs-body-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    /* Dark Mode Support for Heatmap Container */
    body.dark-theme .heatmap-container-wrapper {
        background-color: #232227 !important; /* Match calendar dark bg */
        border: 1px solid #444;
    }
    body.dark-theme .card-title {
        color: #e1e1e1;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
        <div class="main-panel" style="width: 100%;"> 
            <div class="content-wrapper">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-rounded">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2 class="card-title mb-0">Transaction Activity Heatmap</h2>
                                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                        <i class="mdi mdi-arrow-left me-2"></i>Back to Dashboard
                                    </a>
                                </div>
                                <div class="heatmap-container-wrapper">
                                    <div id="calendar-heatmap-container" style="width:100%; min-height:180px;">
                                        <!-- Heatmap rendered here -->
                                    </div>
                                    <!-- Optional: <div id="calendar-heatmap-legend" class="mt-2"></div> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ calendar_heatmap_data_json|json_script:"calendar-heatmap-data" }}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <!-- Cal-Heatmap JS and D3.js (dependency for Cal-Heatmap v4) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const heatmapDataEl = document.getElementById('calendar-heatmap-data');
        const heatmapContainer = document.getElementById('calendar-heatmap-container');

        if (heatmapDataEl && heatmapContainer && typeof CalHeatmap !== 'undefined') {
            try {
                const rawHeatmapData = JSON.parse(heatmapDataEl.textContent || '{}');
                
                const formattedHeatmapData = {};
                for (const dateStr in rawHeatmapData) { // dateStr is 'YYYY-MM-DD'
                    if (rawHeatmapData.hasOwnProperty(dateStr)) {
                        // Parse YYYY-MM-DD into local date components
                        const parts = dateStr.split('-').map(Number);
                        // Create a new Date object for midnight LOCAL TIME on that date
                        const localMidnightDate = new Date(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0);
                        const timestamp = localMidnightDate.getTime() / 1000; // Timestamp in seconds for local midnight
                        formattedHeatmapData[timestamp] = rawHeatmapData[dateStr];
                        // console.log(`Original: ${dateStr}, Local Midnight: ${localMidnightDate.toString()}, Timestamp: ${timestamp}, Count: ${rawHeatmapData[dateStr]}`);
                    }
                }

                // Ensure Cal-Heatmap's start date is also local midnight
                const today = new Date();
                const yearAgoLocalMidnight = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate(), 0, 0, 0, 0);

                console.log("Data being passed to Cal-Heatmap:", formattedHeatmapData); // Keep this for verification

                if (Object.keys(formattedHeatmapData).length > 0) {
                    const cal = new CalHeatmap();
                    cal.paint({
                        itemSelector: heatmapContainer,
                        data: {
                            source: formattedHeatmapData,
                            type: 'json',
                        },
                        date: { 
                            start: yearAgoLocalMidnight, // Use local midnight for start date
                            // defaults to browser's local timezone
                        },
                        range: 12,
                        domain: {
                            type: 'month',
                            label: { text: 'MMM', textAlign: 'start', position: 'top' },
                            padding: [10, 10, 10, 10],
                            gutter: 5,
                        },
                        subDomain: {
                            type: 'ghDay',
                            radius: 2,
                            width: 11,
                            height: 11,
                            gutter: 3
                        },
                        scale: {
                            color: {
                                type: 'threshold',
                                // scheme or range/domain
                                // scheme: 'Greens', 
                                //range: ['#EBEDF0', '#c6e48b', '#7bc96f', '#239a3b', '#196127'], // GitHub-like, including a color for 0
                                //domain: [0, 1, 3, 6, 10] // Counts for color changes (0 means the lightest color)
                                range: ['#EBEDF0', '#239a3b'], // Base color, Strong green
                                domain: [1] // Threshold is 1
                            }
                        },
                        tooltip: {
                            text: function(date, value, dayjsDate) {
                                return (value ? value : 'No') + ' transaction(s) on ' + dayjsDate.format('LL');
                            }
                        }
                    });
                } else {
                   heatmapContainer.innerHTML = '<p class="text-muted small">No transaction data for the heatmap in the last year.</p>';
                }

            } catch (e) {
                console.error('Error processing or rendering calendar heatmap:', e);
                if (heatmapContainer) {
                    heatmapContainer.innerHTML = '<p class="text-danger">Error loading heatmap data.</p>';
                }
            }
        } else if (!heatmapContainer) {
            console.warn('Heatmap container not found.');
        } else if (typeof CalHeatmap === 'undefined') {
            console.warn('CalHeatmap library not loaded. Skipping heatmap rendering.');
            if (heatmapContainer) {
                heatmapContainer.innerHTML = '<p class="text-danger">Calendar Heatmap library (CalHeatmap) not loaded.</p>';
            }
        }
    });
  </script>
{% endblock %}