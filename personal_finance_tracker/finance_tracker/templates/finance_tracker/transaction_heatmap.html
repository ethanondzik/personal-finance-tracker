{% extends "authenticated_base.html" %}
{% load static %}

{% block title %}Transaction Heatmap (D3) - {{ block.super }}{% endblock %}

{% block extra_css %}

  <style>
    
    .heatmap-container-wrapper {
      padding: 10px;
      background-color: var(--bs-body-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-top: 1rem;

      overflow-x: auto;
      overflow-y: hidden; 

      width: 100%;
      padding-bottom: 15px; /* Room for scrollbar */
    }

    #d3-calendar-heatmap-container {
        display: inline-block; 
        vertical-align: top; 
        
    }

    .calendar-heatmap-svg {
        display: block; 
    }

    .year-group .year-title {
        font-size: 16px;
        font-weight: bold;
        fill: #555;
        text-anchor: middle;
    }

    body.dark-theme .card-title {
        color: #e1e1e1; 
    }
    body.dark-theme .heatmap-container-wrapper {
        background-color: #232227; 
        border: 1px solid #444;
    }

    .calendar-heatmap .month-label {
        font-size: 10px;
        fill: #767676;
    }
    .calendar-heatmap .day-cell {
        stroke: rgba(27, 31, 35, 0.06);
        stroke-width: 1px;
    }
    .calendar-heatmap .day-cell:hover {
        stroke: rgba(27, 31, 35, 0.3);
    }
    .calendar-heatmap .wday-label {
        font-size: 9px;
        fill: #767676;
    }

    body.dark-theme .calendar-heatmap .month-label,
    body.dark-theme .calendar-heatmap .wday-label {
        fill: #888;
    }
    body.dark-theme .calendar-heatmap .day-cell {
        stroke: rgba(100, 100, 100, 0.2);
    }
     body.dark-theme .calendar-heatmap .day-cell:hover {
        stroke: rgba(150, 150, 150, 0.5);
    }
    .tooltip {
        position: absolute;
        text-align: center;
        padding: 4px 8px;
        font: 12px sans-serif;
        background: #333;
        color: #fff;
        border: 0px;
        border-radius: 4px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 1070; /* Ensure tooltip is above other elements */
    }
    body.dark-theme .tooltip {
        background: #f0f0f0;
        color: #333;
    }
    .heatmap-toggle {
        margin-bottom: 15px;
        text-align: center;
    }
    .heatmap-toggle label {
        margin-right: 10px;
        margin-left: 5px;
    }

  </style>
{% endblock %}

{% block content %}
<div class="container-scroller">
    <div class="container-fluid page-body-wrapper">
        <div class="main-panel" style="width: 100%;">
            <div class="content-wrapper">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-rounded">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h2 class="card-title mb-0">Transaction Activity Heatmap</h2>
                                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                        <i class="mdi mdi-arrow-left me-2"></i>Back to Dashboard
                                    </a>
                                </div>
                                <div class="heatmap-toggle">
                                    <input type="radio" id="modeCount" name="heatmapMode" value="count" checked>
                                    <label for="modeCount">Transaction Count</label>
                                    <input type="radio" id="modeNetActivity" name="heatmapMode" value="netActivity">
                                    <label for="modeNetActivity">Net Activity</label>
                                    <input type="radio" id="modeTotalSpending" name="heatmapMode" value="totalSpending">
                                    <label for="modeTotalSpending">Total Spending</label>
                                    <input type="radio" id="modeTotalIncome" name="heatmapMode" value="totalIncome">
                                    <label for="modeTotalIncome">Total Income</label>
                                </div>
                                <div class="heatmap-container-wrapper">
                                    <div id="d3-calendar-heatmap-container">
                                        <!-- D3 Heatmap rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ calendar_heatmap_data_json|json_script:"calendar-heatmap-data" }}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const heatmapDataEl = document.getElementById('calendar-heatmap-data');
        const d3Container = document.getElementById('d3-calendar-heatmap-container');
        const modeRadios = document.querySelectorAll('input[name="heatmapMode"]');

        if (!heatmapDataEl || !d3Container) {
            console.error('Required elements for D3 heatmap not found.');
            if (d3Container) d3Container.innerHTML = '<p class="text-danger">Error: Could not initialize heatmap.</p>';
            return;
        }

        const rawData = JSON.parse(heatmapDataEl.textContent || '{}'); 
        if (Object.keys(rawData).length === 0) {
            d3Container.innerHTML = '<p class="no-heatmap-data">No transaction data available to display.</p>';
            return;
        }

        const dataByDate = new Map();
        let minDate = null;
        let maxDate = null;

        for (const dateStr in rawData) {
            if (rawData.hasOwnProperty(dateStr)) {
                dataByDate.set(dateStr, rawData[dateStr]);
                const currentDate = new Date(dateStr + "T00:00:00"); // Ensure local time
                if (!minDate || currentDate < minDate) minDate = currentDate;
                if (!maxDate || currentDate > maxDate) maxDate = currentDate;
            }
        }
        
        if (!minDate || !maxDate) {
             d3Container.innerHTML = '<p class="no-heatmap-data">Could not determine date range from data.</p>';
            return;
        }

        const minYear = minDate.getFullYear();
        const maxYear = maxDate.getFullYear();

        const cellSize = 14; 
        const cellPadding = 2; 
        const weekDayLabelWidth = 25; 
        const monthLabelHeight = 20;
        const yearTitleHeight = 30; 
        const yearPadding = 40; // Horizontal padding between year blocks

        const singleYearWidth = (cellSize + cellPadding) * 53 + weekDayLabelWidth;
        const totalSVGHeight = (cellSize + cellPadding) * 7 + monthLabelHeight + yearTitleHeight;
        
        let totalSVGWidth = 0;
        for (let y = minYear; y <= maxYear; y++) {
            totalSVGWidth += singleYearWidth + (y < maxYear ? yearPadding : 0);
        }


        const countColorScale = d3.scaleThreshold()
            .domain([1, 3, 6, 10, 15]) 
            .range(['#EBEDF0', '#c6e48b', '#7bc96f', '#239a3b', '#196127', '#0e4429']);

        const colorNetIncome = "#28a745"; // Green
        const colorNetExpense = "#dc3545"; // Red
        const colorNeutralOrMixed = "#ffc107"; // Amber/Yellow
        const colorNoTransactions = "#EBEDF0";

        const netActivityColorScale = d3.scaleOrdinal()
            .domain(["netIncome", "netExpense", "neutralOrMixed", "noTransactions"])
            .range([colorNetIncome, colorNetExpense, colorNeutralOrMixed, colorNoTransactions]);
        
        const amountColorScale = d3.scaleThreshold()
            .domain([1, 50, 100, 250, 500]) //income thresholds
            .range(['#EBEDF0', '#D1E5F0', '#92C5DE', '#4393C3', '#2166AC', '#053061']); 


        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip");

        function drawHeatmap(selectedMode) {
            d3Container.innerHTML = ''; // Clear previous heatmap

            const mainSvg = d3.select(d3Container)
                .append("svg")
                .attr("width", totalSVGWidth)
                .attr("height", totalSVGHeight)
                .attr("class", "calendar-heatmap-svg");

            let currentXOffset = 0;

            for (let year = minYear; year <= maxYear; year++) {
                const yearGroup = mainSvg.append("g")
                    .attr("class", "year-group")
                    .attr("transform", `translate(${currentXOffset}, 0)`);

                yearGroup.append("text")
                    .attr("class", "year-title")
                    .attr("x", (singleYearWidth - weekDayLabelWidth) / 2 + weekDayLabelWidth)
                    .attr("y", yearTitleHeight - 10)
                    .text(year);

                const yearStartDate = new Date(year, 0, 1);
                const yearEndDate = new Date(year + 1, 0, 1);
                const datesForYear = d3.timeDays(yearStartDate, yearEndDate);

                const yearDataGroup = yearGroup.append("g")
                    .attr("transform", `translate(0, ${yearTitleHeight})`);

                // Day cells for the current year
                yearDataGroup.append("g")
                    .attr("transform", `translate(${weekDayLabelWidth}, ${monthLabelHeight})`)
                    .selectAll(`.day-cell-year-${year}`)
                    .data(datesForYear)
                    .enter().append("rect")
                    .attr("class", `day-cell day-cell-year-${year}`)
                    .attr("width", cellSize)
                    .attr("height", cellSize)
                    .attr("x", d => d3.timeWeek.count(yearStartDate, d) * (cellSize + cellPadding))
                    .attr("y", d => d.getDay() * (cellSize + cellPadding))
                    .attr("fill", d => {
                        const dateStr = d3.timeFormat("%Y-%m-%d")(d);
                        const dayData = dataByDate.get(dateStr);

                        if (selectedMode === 'count') {
                            const count = dayData ? dayData.count : 0;
                            return countColorScale(count);
                        } else if (selectedMode === 'netActivity') {
                            if (!dayData || dayData.count === 0) return netActivityColorScale("noTransactions");
                            const net = dayData.income - dayData.expense;
                            if (net > 0.01) return netActivityColorScale("netIncome"); // Use a small threshold for float precision
                            if (net < -0.01) return netActivityColorScale("netExpense");
                            return netActivityColorScale("neutralOrMixed");
                        } else if (selectedMode === 'totalSpending') {
                            const expense = dayData ? dayData.expense : 0;
                            return amountColorScale(expense);
                        } else if (selectedMode === 'totalIncome') {
                            const income = dayData ? dayData.income : 0;
                            return amountColorScale(income);
                        }
                        return colorNoTransactions; 
                    })
                    .on("mouseover", function(event, d) {
                        d3.select(this).style("stroke", "black");
                        tooltip.transition().duration(100).style("opacity", .9);
                        const dateStr = d3.timeFormat("%Y-%m-%d")(d);
                        const dayData = dataByDate.get(dateStr);
                        let tooltipHtml = `No transactions<br/>on ${d3.timeFormat("%b %d, %Y")(d)}`;
                        if (dayData) {
                            tooltipHtml = `
                                ${dayData.count} transaction(s)<br/>
                                Income: ${dayData.income.toFixed(2)}<br/>
                                Expense: ${dayData.expense.toFixed(2)}<br/>
                                Net: ${(dayData.income - dayData.expense).toFixed(2)}<br/>
                                on ${d3.timeFormat("%b %d, %Y")(d)}
                            `;
                        }
                        tooltip.html(tooltipHtml)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this).style("stroke", null);
                        tooltip.transition().duration(300).style("opacity", 0);
                    });

                // Month labels for the current year
                yearDataGroup.append("g")
                    .attr("transform", `translate(${weekDayLabelWidth}, 0)`)
                    .selectAll(`.month-label-year-${year}`)
                    .data(d3.timeMonths(new Date(year, 0, 1), new Date(year, 11, 2)))
                    .enter().append("text")
                    .attr("class", `month-label month-label-year-${year}`)
                    .attr("x", d => d3.timeWeek.count(yearStartDate, d3.timeWeek.floor(d)) * (cellSize + cellPadding) + (cellSize + cellPadding) / 2)
                    .attr("y", monthLabelHeight - 5)
                    .text(d3.timeFormat("%b"));

                // Day of the week labels (M, W, F) - only need to draw once if consistent, but per year is fine
                const dayLabels = ["S", "M", "T", "W", "T", "F", "S"]; // Show all for clarity
                 yearDataGroup.append("g")
                    .attr("transform", `translate(0, ${monthLabelHeight})`)
                    .selectAll(`.wday-label-year-${year}`)
                    .data(d3.range(7)) // 0 (Sun) to 6 (Sat)
                    .enter().append("text")
                    .attr("class", `wday-label wday-label-year-${year}`)
                    .attr("x", weekDayLabelWidth - 10) // Adjusted for better centering
                    .attr("y", d => d * (cellSize + cellPadding) + cellSize / 1.5)
                    .attr("text-anchor", "middle")
                    .text(d => (d % 2 !== 0) ? dayLabels[d] : ""); // Show M, W, F (or adjust as preferred)


                currentXOffset += singleYearWidth + yearPadding;
            }
        }

        modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                drawHeatmap(this.value);
            });
        });

        try {
            drawHeatmap(document.querySelector('input[name="heatmapMode"]:checked').value);
        } catch (e) {
            console.error('Error rendering D3 heatmap:', e);
            if (d3Container) d3Container.innerHTML = '<p class="text-danger">An error occurred while rendering the D3 heatmap.</p>';
        }
    });
  </script>
{% endblock %}

