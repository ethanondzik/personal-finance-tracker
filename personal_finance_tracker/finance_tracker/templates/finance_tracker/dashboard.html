<!DOCTYPE html>
<html lang="en" class="{{ request.theme }}-theme">
  <head>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Finance Tracker</title>

    <!-- Plugins CSS -->
    <link rel="stylesheet" href="{% static 'vendors/simple-line-icons/css/simple-line-icons.css' %}">
    <!--To search for more mdi icons, search online here: https://pictogrammers.com/library/mdi/-->
    <link rel="stylesheet" href="{% static 'vendors/mdi/css/materialdesignicons.min.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/bootstrap-datepicker/bootstrap-datepicker.min.css' %}">
    <link rel="stylesheet" href="{% static 'vendors/datatables.net-bs4/dataTables.bootstrap4.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="shortcut icon" href="{% static 'images/favicon-32x32.png' %}" />
    <link rel="stylesheet" href="{% static 'css/dark-theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom_pagination.css' %}"> 


  </head>
  <body class="with-welcome-text {{ request.theme }}-theme">
    <div class="container-scroller">

      <!-- Navbar -->
      <nav class="navbar default-layout col-lg-12 col-12 p-0 fixed-top d-flex align-items-top flex-row">
        <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
          <div class="me-3">
            <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-bs-toggle="minimize">
              <span class="icon-menu"></span>
            </button>
          </div>
        </div>
        <div class="navbar-menu-wrapper d-flex align-items-top">
          <ul class="navbar-nav">
            <li class="nav-item fw-semibold d-none d-lg-block ms-0">
              <h1 class="welcome-text">
                <span id="greeting"></span>, <span class="text-black fw-bold">{{ user.username }}</span></h1>
              <h3 class="welcome-sub-text">Your finance summary this week</h3>
            </li>
          </ul>
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown d-none d-lg-block user-dropdown">
              <a class="nav-link" id="UserDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                <img class="img-xs rounded-circle" src="{% static 'images/profile-user.png' %}" alt="Profile image">
              </a>
              <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="UserDropdown">
                <div class="dropdown-header text-center">
                  <img class="img-md rounded-circle" src="{% static 'images/profile-user.png' %}" width="100px" height="100px" alt="Profile image">
                  <p class="mb-1 mt-3 fw-semibold">{{ user.username }}</p>
                  <p class="fw-light text-muted mb-0">{{ user.email }}</p>
                </div>
                <a class="dropdown-item" href="{% url 'manage_account' %}">
                  <i class="dropdown-item-icon mdi mdi-account text-primary me-2"></i>Manage Account
                </a>
                <a class="dropdown-item" id="theme-toggle" href="javascript:void(0);">
                  <i class="dropdown-item-icon mdi mdi-brightness-6 text-primary me-2"></i> Dark Mode / Light Mode
                </a>
                <a class="dropdown-item" onclick="document.getElementById('logout-form').submit();"><i class="dropdown-item-icon mdi mdi-power text-primary me-2"></i>Sign Out</a>
                <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">
                  {% csrf_token %}
                </form>
              </div>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Page Body Wrapper -->
      <div class="container-fluid page-body-wrapper">
        <!-- Sidebar -->
        <nav class="sidebar sidebar-offcanvas" id="sidebar">
          <ul class="nav">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'dashboard' %}">
                <i class="mdi mdi-view-dashboard menu-icon"></i>
                <span class="menu-title">Dashboard</span>
              </a>
            </li>                        
            <li class="nav-item">
              <a class="nav-link" href="{% url 'manage_bank_accounts' %}">
                <i class="mdi mdi-bank menu-icon"></i>
                <span class="menu-title">Bank Accounts</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'manage_categories' %}">
                <i class="mdi mdi-grid-large menu-icon"></i>
                <span class="menu-title">Categories</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'query_transactions' %}">
                <i class="mdi mdi-magnify menu-icon"></i>
                <span class="menu-title">Query Transactions</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'manage_subscriptions' %}">
                  <i class="mdi mdi-calendar-clock menu-icon"></i>
                  <span class="menu-title">Subscriptions</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'transaction_calendar' %}">
                  <i class="mdi mdi-calendar-month menu-icon"></i>
                  <span class="menu-title">Calendar View</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'transaction_timeline' %}">
                  <i class="mdi mdi-calendar-month menu-icon"></i>
                  <span class="menu-title">Timeline View</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'notification_settings' %}">
                <i class="mdi mdi-bell menu-icon"></i>
                <span class="menu-title">Notifications</span>
              </a>
            </li> 
            <li class="nav-item">
              <a class="nav-link" href="{% url 'manage_budgets' %}">
                <i class="mdi mdi-cash-multiple menu-icon"></i>
                <span class="menu-title">Budgets</span>
              </a>
            </li>        
          </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-panel">
          <div class="content-wrapper">
            <!-- Django Messages -->
            {% if messages %}
            <div class="container mt-3">
              {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Cards Layout -->
            <div class="tab-content tab-content-basic">
              <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview">
                <!-- Statistics Row -->
                <div class="row">
                  <div class="col-sm-12">
                    <div class="statistics-details d-flex align-items-center justify-content-between">
                      <!-- Stats bar -->
                      <div>
                        <p class="statistics-title">Total Income</p>
                        <h3 class="rate-percentage">${{ chart_data.total_income|floatformat:2 }}</h3>
                      </div>
                      <div>
                        <p class="statistics-title">Total Expenses</p>
                        <h3 class="rate-percentage">${{ chart_data.total_expenses|floatformat:2 }}</h3>
                      </div>
                      <!-- Add more stats as needed -->
                    </div>
                  </div>
                </div>
                <div class="row">
                  <!-- Left Column (75% width) -->
                  <div class="col-lg-8 d-flex flex-column">
                    <div class="row flex-grow">
                      <!-- Transactions Table -->
                      <div class="col-12 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <h4 class="card-title">Monthly Overview</h4>
                            <canvas id="monthlyBarChart" style="max-height: 200px;"></canvas>
                          </div>
                        </div>
                      </div>
                      <!-- Line Chart -->
                      <div class="col-12 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <h4 class="card-title">Transactions Graph</h4>
                            <canvas id="transactionChart" style="height: 400px; max-height: 700px;"></canvas>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Right Column (25% width) -->
                  <div class="col-lg-4 d-flex flex-column">
                    <div class="row flex-grow">
                      <!-- Pie Chart -->
                      <div class="col-md-6 col-lg-12 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <h4 class="card-title">Pie Chart</h4>
                            <canvas id="pieChart" style="height:400px; max-height:700px;"></canvas>
                          </div>
                        </div>
                      </div>
                      <!-- Blue Card -->
                      <div class="col-md-6 col-lg-12 grid-margin stretch-card">
                        <div class="card bg-primary card-rounded">
                          <div class="card-body">
                            <h4 class="card-title text-white">Quick Stats</h4>
                            <div class="row">
                              <div class="col-12">
                                  <p class="text-white">Bank Accounts</p>
                                  <ul class="list-group">
                                      {% for account in accounts %}
                                      <li class="list-group-item d-flex justify-content-between align-items-center">
                                          <span>
                                              <strong>{{ account.account_number }}</strong> 
                                              ({{ account.account_type|capfirst }})
                                          </span>
                                          <span class="badge bg-success text-white">
                                              ${{ account.balance|floatformat:2 }}
                                          </span>
                                      </li>
                                      {% empty %}
                                      <li class="list-group-item text-center text-muted">
                                          No bank accounts found.
                                      </li>
                                      {% endfor %}
                                  </ul>
                              </div>
                          </div>
                          </div>
                        </div>
                      </div>
                      <!-- Subscriptions Card -->
                      <div class="col-md-6 col-lg-12 grid-margin stretch-card">
                        <div class="card card-rounded bg-gradient-info text-white">
                          <div class="card-body pb-0">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                              <h4 class="card-title text-white mb-0">Upcoming Subscriptions</h4>
                              <a href="{% url 'manage_subscriptions' %}" class="btn btn-sm btn-light">Manage</a>
                            </div>
                            
                            {% if upcoming_subscriptions %}
                              <div class="subscription-list">
                                {% for subscription in upcoming_subscriptions %}
                                  <div class="subscription-item d-flex align-items-center mb-3 p-2 rounded {% if subscription.days_until <= 3 %}border-danger{% endif %}">
                                    <div class="subscription-date me-3 text-center">
                                      <h3 class="mb-0">{{ subscription.next_payment_date|date:"d" }}</h3>
                                      <div>{{ subscription.next_payment_date|date:"M" }}</div>
                                    </div>
                                    <div class="subscription-details flex-grow-1">
                                      <div class="fw-bold">{{ subscription.name }}</div>
                                      <small>{{ subscription.get_frequency_display }}</small>
                                    </div>
                                    <div class="subscription-amount fw-bold">
                                      ${{ subscription.amount|floatformat:2 }}
                                    </div>
                                    <div class="ms-3">
                                      {% if subscription.days_until == 0 %}
                                        <span class="badge bg-danger">Today</span>
                                      {% elif subscription.days_until == 1 %}
                                        <span class="badge bg-warning">Tomorrow</span>
                                      {% elif subscription.days_until <= 7 %}
                                        <span class="badge bg-warning">{{ subscription.days_until }} days</span>
                                      {% else %}
                                        <span class="badge bg-info">{{ subscription.days_until }} days</span>
                                      {% endif %}
                                    </div>
                                  </div>
                                {% endfor %}
                              </div>
                              {% if upcoming_subscriptions|length >= 3 %}
                                <div class="text-center mt-3 mb-2">
                                  <a href="{% url 'manage_subscriptions' %}" class="text-white text-decoration-underline">View all subscriptions</a>
                                </div>
                              {% endif %}
                            {% else %}
                              <div class="text-center py-4">
                                <div class="mb-3">
                                  <i class="mdi mdi-calendar-check mdi-48px"></i>
                                </div>
                                <p>No upcoming subscriptions</p>
                                <a href="{% url 'manage_subscriptions' %}" class="btn btn-outline-light btn-sm mt-2">
                                  <i class="mdi mdi-plus-circle me-1"></i>Add Subscription
                                </a>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                          <h5 class="mb-0">Budgets</h5>
                        </div>
                        <div class="card-body">
                          <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                              <thead>
                                <tr>
                                  <th>Category</th>
                                  <th>Budgeted</th>
                                  <th>Spent</th>
                                  <th>Remaining</th>
                                  <th>Progress</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for b in budget_data %}
                                <tr>
                                  <td>{{ b.name }}</td>
                                  <td>${{ b.budget|floatformat:2 }}</td>
                                  <td>${{ b.spent|floatformat:2 }}</td>
                                  <td>${{ b.remaining|floatformat:2 }}</td>
                                  <td>
                                    <div class="d-flex align-items-center">
                                      <div class="progress flex-grow-1" style="height: 18px; min-width: 80px;">
                                        <div class="progress-bar
                                          {% if b.spent > b.budget %}bg-danger
                                          {% elif b.progress > 75 %}bg-warning
                                          {% else %}bg-success
                                          {% endif %}"
                                          role="progressbar"
                                          style="width: {% widthratio b.spent b.budget 100 %}%;"
                                          aria-valuenow="{% widthratio b.spent b.budget 100 %}"
                                          aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                      </div>
                                      <span class="ms-2 small">
                                        {{ b.spent|floatformat:2 }}/{{ b.budget|floatformat:2 }}
                                        ({{ b.progress|floatformat:0 }}%)
                                      </span>
                                    </div>
                                  </td>
                                </tr>
                                {% empty %}
                                <tr>
                                  <td colspan="5" class="text-center text-muted">No budgets set.</td>
                                </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                      
                      <!-- {{ budget_data|json_script:"budget-data" }} -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content mt-4">
              <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0">Filter Transaction List</h5>
                </div>
                <div class="card-body">
                  <form method="get" class="row g-3" action="{% url 'dashboard' %}#table-view">
                    <div class="col-md-3">
                      <label for="filter_type" class="form-label">Type</label>
                      <select name="type" id="filter_type" class="form-select">
                        <option value="">All</option>
                        <option value="income" {% if request.GET.type == "income" %}selected{% endif %}>Income</option>
                        <option value="expense" {% if request.GET.type == "expense" %}selected{% endif %}>Expense</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label for="filter_category" class="form-label">Category</label>
                      <select name="category" id="filter_category" class="form-select">
                        <option value="">All</option>
                        {% for cat in categories %}
                          <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label for="filter_start" class="form-label">Start Date</label>
                      <input type="date" name="start" id="filter_start" class="form-control" value="{{ request.GET.start }}">
                    </div>
                    <div class="col-md-3">
                      <label for="filter_end" class="form-label">End Date</label>
                      <input type="date" name="end" id="filter_end" class="form-control" value="{{ request.GET.end }}">
                    </div>
                    <div class="col-12">
                      <button type="submit" class="btn btn-primary">Apply Filters</button>
                      <a href="{% url 'dashboard' %}" class="btn btn-secondary">Reset</a>
                    </div>
                  </form>
                </div>
              </div>
              <!-- Transactions Table -->
              <div class="tab-pane fade show active" id="table-view" role="tabpanel" aria-labelledby="table-tab">
                <div class="row">
                  <div class="col-lg-12 grid-margin stretch-card">
                    <div class="card">
                      <div class="card-body">
                        <h4 class="card-title">Transactions</h4>
                        <form id="delete-form" method="post" action="{% url 'delete_transactions' %}">
                          {% csrf_token %}
                          <div class="table-responsive">
                            <table class="table table-striped">
                              <thead>
                                <tr>
                                  <th><input type="checkbox" id="select-all"></th>
                                  <th>Date</th>
                                  <th>Account</th>
                                  <th>Type</th>
                                  <th>Amount</th>
                                  <th>Description</th>
                                  <th>Actions</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for transaction in transactions %}
                                <tr class="clickable-row" onclick="toggleDetails('{{ transaction.id }}')">
                                  <td>
                                    <input type="checkbox" name="transaction_ids" value="{{ transaction.id }}" class="transaction-checkbox" onclick="event.stopPropagation();">
                                  </td>
                                  <td>
                                    <i class="mdi mdi-chevron-down"></i>
                                    {{ transaction.date }}
                                  </td>
                                  <td>{{ transaction.account.account_number }}</td>
                                  <td>{{ transaction.get_transaction_type_display }}</td> 
                                  <td>{{ transaction.amount }}</td>
                                  <td>{{ transaction.description }}</td>
                                  <td>
                                    <a href="{% url 'update_transaction' transaction.id %}" class="btn btn-sm btn-warning" onclick="event.stopPropagation();">Edit</a>
                                  </td>
                                </tr>
                                <!-- EXPANDED TRANSACTION DETAILS-->
                                <tr id="details{{ transaction.id }}" class="collapse">
                                    <td colspan="5">
                                      <strong>Category:</strong> {{ transaction.category }}<br>
                                      <strong>Account Number:</strong> {{ transaction.account.account_number }}<br>
                                      <strong>Account Type:</strong> {{ transaction.account.account_type }}<br>
                                      <strong>Account Balance:</strong> ${{ transaction.account.balance }}<br>
                                    </td>                               
                                </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                          <!-- Add a hidden input to include the 'confirm' key for the delete view-->
                          <input type="hidden" name="confirm" value="true">
                        </form>
                        
                        <div class="d-flex mt-3">
                          <a href="{% url 'add_transaction' %}" class="btn btn-primary ms-3">Add Transaction</a>
                          <a href="{% url 'upload_transactions' %}" class="btn btn-secondary ms-3">Upload CSV</a>
                          <button type="button" id="delete-selected-btn" class="btn btn-danger ms-3" onclick="prepareDeleteMultiple()">Delete Selected</button>
                        </div>
                        <!-- Pagination Controls -->
                        <nav aria-label="Page navigation" class="mt-4">
                          <ul class="pagination justify-content-center pagination-lg">
                            {% if transactions.has_previous %}
                              <li class="page-item">
                                <a class="page-link rect-page-link" href="?page={{ transactions.previous_page_number }}{{ request.GET.urlencode|cut:'page='|yesno:'&,' }}#table-view" aria-label="Previous">
                                  <span aria-hidden="true"><i class="mdi mdi-chevron-left"></i></span>
                                </a>
                              </li>
                            {% else %}
                              <li class="page-item disabled">
                                <span class="page-link rect-page-link"><i class="mdi mdi-chevron-left"></i></span>
                              </li>
                            {% endif %}
                        
                            {% for num in transactions.paginator.page_range %}
                              {% if num == transactions.number %}
                                <li class="page-item active">
                                  <span class="page-link rect-page-link bg-primary border-primary text-white">{{ num }}</span>
                                </li>
                              {% elif num > transactions.number|add:'-3' and num < transactions.number|add:'3' %}
                                <li class="page-item">
                                  <a class="page-link rect-page-link" href="?page={{ num }}{{ request.GET.urlencode|cut:'page='|yesno:'&,' }}#table-view">{{ num }}</a>
                                </li>
                              {% elif num == 1 or num == transactions.paginator.num_pages %}
                                <li class="page-item">
                                  <a class="page-link rect-page-link" href="?page={{ num }}{{ request.GET.urlencode|cut:'page='|yesno:'&,' }}#table-view">{{ num }}</a>
                                </li>
                                {% if num < transactions.number|add:'-3' or num > transactions.number|add:'3' %}
                                  <li class="page-item disabled"><span class="page-link rect-page-link">…</span></li>
                                {% endif %}
                              {% endif %}
                            {% endfor %}
                        
                            {% if transactions.has_next %}
                              <li class="page-item">
                                <a class="page-link rect-page-link" href="?page={{ transactions.next_page_number }}{{ request.GET.urlencode|cut:'page='|yesno:'&,' }}#table-view" aria-label="Next">
                                  <span aria-hidden="true"><i class="mdi mdi-chevron-right"></i></span>
                                </a>
                              </li>
                            {% else %}
                              <li class="page-item disabled">
                                <span class="page-link rect-page-link"><i class="mdi mdi-chevron-right"></i></span>
                              </li>
                            {% endif %}
                          </ul>
                        </nav>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          
          <!-- Footer -->
          <footer class="footer" style="border: 0;">
            <div class="d-sm-flex justify-content-center justify-content-sm-between">
              <!-- <span class="text-muted d-block text-center text-sm-left d-sm-inline-block">Track your finances!</span> -->
            </div>
          </footer>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete the following transaction(s)?</p>
            <ul id="transaction-list" class="list-group"></ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- <button id="scrollToTopBtn" class="btn btn-primary rounded-circle shadow-lg"> -->
    <button id="scrollToTopBtn" class="btn btn-primary shadow-lg" style="width: 40px">
      <i class="mdi mdi-arrow-up"></i>
    </button>

    <!-- Plugins JS -->
    <script src="{% static 'vendors/js/vendor.bundle.base.js' %}"></script>
    <script src="{% static 'js/jquery.cookie.js' %}"></script>
    <script src="{% static 'vendors/bootstrap-datepicker/bootstrap-datepicker.min.js' %}"></script>
    <script src="{% static 'vendors/chart.js/Chart.min.js' %}"></script>

    <!-- inject:js -->
    <script src="{% static 'js/off-canvas.js' %}"></script>
    <script src="{% static 'js/hoverable-collapse.js' %}"></script>
    <script src="{% static 'js/template.js' %}"></script>

    <!-- Custom js for this page-->
    <script src="{% static 'js/custom_collapse.js' %}"></script>
    <script src="{% static 'js/dashboard_modal.js' %}"></script>
    <script src="{% static 'js/message_timeout.js' %}"></script>
    <script src="{% static 'js/transaction_graph.js' %}"></script>
    <script src="{% static 'js/greetings.js' %}"></script>
    <script src="{% static 'js/scroll_to_top.js' %}"></script>
    <script src="{% static 'js/theme-toggle.js' %}"></script>
    <script src="{% static 'js/notifications.js' %}"></script>

    <!-- Chart Data -->
   


    <!-- Chart Data & Custom Notifications Data -->
    {{ chart_data|json_script:"chart-data" }}
    {{ user_custom_notifications|json_script:"user-custom-notifications-data" }} 
    {{ accounts|json_script:"accounts-data" }}
    {{ budget_data|json_script:"budget-data" }} 
    {{ request.session.show_large_transaction_notification|json_script:"notification-data" }} 
    

    <script>
      // Show notification for upcoming subscription payment
      function notifySubscriptionDue(subscription) {
        if (window.NotificationManager && window.NotificationManager.isNotificationEnabled('subscription')) {
          // Get user preference for days threshold (default to 3)
          const daysThreshold = parseInt(localStorage.getItem('subscription_days') || '3', 10);
          
          // Only notify if within threshold
          if (subscription.days_until <= daysThreshold) {
            window.NotificationManager.show('Subscription Payment Due Soon', {
              body: `${subscription.name} payment of $${subscription.amount} due in ${subscription.days_until} days`,
              requireInteraction: true,
              tag: `subscription-${subscription.id}`, // Prevents duplicate notifications
              onclick: function() {
                window.location.href = '/manage-subscriptions/';
              }
            });
          }
        }
      }

      // For low balance warning
      function checkAccountBalances() {
        if (window.NotificationManager && window.NotificationManager.isNotificationEnabled('balance')) {
          const threshold = parseFloat(localStorage.getItem('balance_threshold') || '100');
          const accounts = JSON.parse(document.getElementById('accounts-data').textContent || '[]');
          // Get or initialize the notified accounts list
          let notified = JSON.parse(localStorage.getItem('low_balance_notified') || '[]');

          accounts.forEach(account => {
            const accountId = account.account_number; // Use a unique identifier (account_number or id)
            const balance = parseFloat(account.balance);

            // If below threshold and not already notified, show notification and add to notified list
            if (balance < threshold && !notified.includes(accountId)) {
              window.NotificationManager.show('Low Account Balance', {
                body: `Your ${account.account_type} account ${account.account_number} balance is below $${threshold}.`,
                requireInteraction: true,
                tag: `low-balance-${accountId}`,
                onclick: function() {
                  window.location.href = '/manage-bank-accounts/';
                }
              });
              notified.push(accountId);
            }

            // If balance is now above threshold and was previously notified, remove from notified list
            if (balance >= threshold && notified.includes(accountId)) {
              notified = notified.filter(id => id !== accountId);
            }
          });

          // Save the updated notified list
          localStorage.setItem('low_balance_notified', JSON.stringify(notified));
        }
      }

      // For budget limit warning
      function checkBudgetLimits() {
        if (window.NotificationManager && window.NotificationManager.isNotificationEnabled('budget')) {
          const percentage = parseInt(localStorage.getItem('budget_percentage') || '75', 10);
          const categories = JSON.parse(document.getElementById('budget-data').textContent || '[]');
          
          categories.forEach(category => {
            if (category.budget && category.spent) {
              const spentPercentage = (category.spent / category.budget) * 100;
              if (spentPercentage >= percentage) {
                window.NotificationManager.show('Budget Limit Warning', {
                  body: `You've spent ${spentPercentage.toFixed(1)}% of your budget for ${category.name}.`,
                  requireInteraction: false,
                  tag: `budget-${category.id}`,
                  onclick: function() {
                    window.location.href = '/query-transactions/?category=' + category.id;
                  }
                });
              }
            }
          });
        }
      }

      // Pass upcoming subscriptions data to JS
      document.addEventListener('DOMContentLoaded', function() {
        // Get subscription data if available
        const subscriptionsElement = document.getElementById('upcoming-subscriptions-data');
        if (subscriptionsElement) {
          const upcomingSubscriptions = JSON.parse(subscriptionsElement.textContent || '[]');
          upcomingSubscriptions.forEach(subscription => {
            notifySubscriptionDue(subscription);
          });
        }
        
        // Check account balances when page loads
        checkAccountBalances();
        
        // Check budget limits when page loads
        checkBudgetLimits();
      });

    </script>
    
    <!-- {{ request.session.show_large_transaction_notification|json_script:"notification-data" }} -->

    <script>
      // Custom Notification Check Functions (from previous response)
      document.addEventListener('DOMContentLoaded', function() {
          const userCustomNotificationsDataEl = document.getElementById('user-custom-notifications-data');
          let userCustomNotifications = [];
          if (userCustomNotificationsDataEl) {
              try {
                  userCustomNotifications = JSON.parse(userCustomNotificationsDataEl.textContent || '[]');
              } catch (e) {
                  console.error('Error parsing user custom notifications data:', e);
              }
          }
      
          function showCustomNotificationIfTypeEnabled(notificationRule, type, title, body, options = {}) {
              if (window.NotificationManager && window.NotificationManager.isNotificationEnabled(type)) {
                  window.NotificationManager.show(title, {
                      body: body,
                      tag: `custom-${type}-${notificationRule.id}-${options.uniqueSuffix || Date.now()}`,
                      requireInteraction: options.requireInteraction !== undefined ? options.requireInteraction : false,
                      onclick: options.onclick
                  });
              }
          }
      
          function checkGenericCustomNotifications() {
            if (!userCustomNotifications.length) return;

            const now = new Date();
            const nowYear = now.getFullYear();
            const nowMonth = now.getMonth();
            const nowDate = now.getDate();
            const nowDay = now.getDay();
            const nowHour = now.getHours();
            const nowMinute = now.getMinutes();

            const todayDateString = now.toISOString().split('T')[0];
            const currentWeekString = `${now.getFullYear()}-W${getWeekNumber(now)}`;
            const currentMonthString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            let shownNotificationsLog = JSON.parse(localStorage.getItem('shownCustomNotificationsLog') || '{}');

            userCustomNotifications.forEach(notif => {
                if ((notif.type === 'generic' || notif.type === 'reminder') && notif.notification_datetime) {
                    const startDateTime = new Date(notif.notification_datetime);
                    if (isNaN(startDateTime.getTime())) return;

                    let shouldShow = false;
                    let notificationInstanceKey = `notif-${notif.id}`;

                    // Extract scheduled time components
                    const schedYear = startDateTime.getFullYear();
                    const schedMonth = startDateTime.getMonth();
                    const schedDate = startDateTime.getDate();
                    const schedDay = startDateTime.getDay();
                    const schedHour = startDateTime.getHours();
                    const schedMinute = startDateTime.getMinutes();

                    switch (notif.recurrence_interval) {
                        case 'NONE':
                            // Show only if exactly the scheduled year, month, day, hour, minute
                            if (
                                nowYear === schedYear &&
                                nowMonth === schedMonth &&
                                nowDate === schedDate &&
                                nowHour === schedHour &&
                                nowMinute === schedMinute
                            ) {
                                shouldShow = true;
                            }
                            // Key remains base key for 'once'
                            break;
                        case 'DAILY':
                            // Show if today and at the scheduled hour/minute
                            if (
                                nowHour === schedHour &&
                                nowMinute === schedMinute
                            ) {
                                shouldShow = true;
                            }
                            notificationInstanceKey += `-${todayDateString}`;
                            break;
                        case 'WEEKLY':
                            // Show if today is the scheduled weekday and at the scheduled hour/minute
                            if (
                                nowDay === schedDay &&
                                nowHour === schedHour &&
                                nowMinute === schedMinute
                            ) {
                                shouldShow = true;
                            }
                            notificationInstanceKey += `-${currentWeekString}`;
                            break;
                        case 'MONTHLY':
                            // Show if today is the scheduled day of the month and at the scheduled hour/minute
                            if (
                                nowDate === schedDate &&
                                nowHour === schedHour &&
                                nowMinute === schedMinute
                            ) {
                                shouldShow = true;
                            }
                            notificationInstanceKey += `-${currentMonthString}`;
                            break;
                    }

                    if (shouldShow && !shownNotificationsLog[notificationInstanceKey]) {
                        showCustomNotificationIfTypeEnabled(notif, notif.type, notif.title, notif.message, {
                            requireInteraction: notif.type === 'reminder',
                            uniqueSuffix: `timed-${notif.id}-${notif.recurrence_interval}`
                        });
                        shownNotificationsLog[notificationInstanceKey] = true;
                    }
                }
            });
            localStorage.setItem('shownCustomNotificationsLog', JSON.stringify(shownNotificationsLog));
        }

          // Helper function to get ISO week number
          function getWeekNumber(d) {
              d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
              d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
              var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
              var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
              return weekNo;
          }
      
          function checkCustomPurchaseNotifications(transactionData) {
              if (!userCustomNotifications.length || !transactionData || !transactionData.amount) return; // Added check for transactionData.amount
              const transactionAmount = parseFloat(transactionData.amount);
      
              userCustomNotifications.forEach(notif => {
                  if (notif.type === 'purchase' && notif.threshold != null) {
                      const categoryMatch = !notif.category_id || (transactionData.category_id === notif.category_id);
                      if (transactionAmount >= notif.threshold && categoryMatch) {
                          let messageBody = `${notif.message} (Transaction: ${transactionData.description || 'N/A'} for $${transactionAmount.toFixed(2)})`;
                          if(notif.category_name) messageBody += ` in category ${notif.category_name}.`;
                          
                          showCustomNotificationIfTypeEnabled(notif, 'purchase', notif.title, messageBody, {
                              uniqueSuffix: transactionData.id || Date.now(), requireInteraction: true // Ensure transactionData.id exists
                          });
                      }
                  }
              });
          }
      
          function checkUserDefinedBalanceNotifications() {
              if (!userCustomNotifications.length) return;
              const accountsDataEl = document.getElementById('accounts-data');
              if (!accountsDataEl) return;
              const accounts = JSON.parse(accountsDataEl.textContent || '[]');
      
              userCustomNotifications.forEach(notif => {
                  if (notif.type === 'balance' && notif.threshold != null) {
                      accounts.forEach(account => {
                          const balance = parseFloat(account.balance);
                          if (balance <= notif.threshold) {
                              showCustomNotificationIfTypeEnabled(notif, 'balance', notif.title, 
                                  `${notif.message} (Account: ${account.name || account.account_number} balance is $${balance.toFixed(2)})`, {
                                  uniqueSuffix: `acc-${account.account_number || account.id}`, requireInteraction: true,
                                  onclick: function() { window.location.href = "{% url 'manage_bank_accounts' %}"; }
                              });
                          }
                      });
                  }
              });
          }
      
          function checkUserDefinedBudgetNotifications() {
              if (!userCustomNotifications.length) return;
              const budgetDataEl = document.getElementById('budget-data');
              if (!budgetDataEl) return;
              const budgets = JSON.parse(budgetDataEl.textContent || '[]'); 
      
              userCustomNotifications.forEach(notif => {
                  if (notif.type === 'budget' && notif.threshold != null) {
                      budgets.forEach(budget => { 
                          if (budget.budget && budget.spent) {
                              const spentPercentage = (parseFloat(budget.spent) / parseFloat(budget.budget)) * 100;
                              const categoryMatch = !notif.category_id || (budget.id === notif.category_id); // budget.id is category_id
      
                              if (spentPercentage >= notif.threshold && categoryMatch) {
                                  showCustomNotificationIfTypeEnabled(notif, 'budget', notif.title,
                                      `${notif.message} (Budget: ${budget.name} is ${spentPercentage.toFixed(1)}% spent)`, {
                                      uniqueSuffix: `budget-${budget.id}`, requireInteraction: true,
                                      onclick: function() { window.location.href = "{% url 'manage_budgets' %}"; }
                                  });
                              }
                          }
                      });
                  }
              });
          }
      
          // --- Call Notification Checks ---
          if (window.NotificationManager && (Notification.permission === 'granted' || Notification.permission === 'default')) {
              
              // Call for built-in notifications
              if (typeof notifySubscriptionDue === 'function') {
                  const subscriptionsElement = document.getElementById('upcoming-subscriptions-data');
                  if (subscriptionsElement) {
                      const upcomingSubscriptions = JSON.parse(subscriptionsElement.textContent || '[]');
                      upcomingSubscriptions.forEach(subscription => { notifySubscriptionDue(subscription); });
                  }
              }
              if (typeof checkAccountBalances === 'function') checkAccountBalances();
              if (typeof checkBudgetLimits === 'function') checkBudgetLimits();   
      
              // Call for custom notifications
              checkGenericCustomNotifications();
              checkUserDefinedBalanceNotifications();
              checkUserDefinedBudgetNotifications();
      
              // For large transaction (built-in) and custom purchase notifications
              const largeTransactionDataEl = document.getElementById('notification-data');
              if (largeTransactionDataEl) {
                  try {
                      const transactionDataFromSession = JSON.parse(largeTransactionDataEl.textContent); // This is from session
                      if (transactionDataFromSession && transactionDataFromSession.amount) { 
                          // Built-in large transaction check
                          const builtInTxThreshold = parseFloat(localStorage.getItem('transaction_threshold') || '100');
                          if (transactionDataFromSession.amount >= builtInTxThreshold && window.NotificationManager.isNotificationEnabled('transaction')) {
                              window.NotificationManager.show('Large Transaction Added', {
                                  body: `A new transaction of $${transactionDataFromSession.amount.toFixed(2)} was added: ${transactionDataFromSession.description}`,
                                  icon: "{% static 'images/favicon.png' %}",
                                  tag: `large-transaction-${transactionDataFromSession.id}`
                              });
                          }
                          // Custom purchase rules check (using the same data from session)
                          checkCustomPurchaseNotifications(transactionDataFromSession);
                      }
                  } catch (e) {
                      console.error('Error processing large transaction/custom purchase notification data:', e);
                  }
              }
          }
      });
    </script>
  </body>
</html>